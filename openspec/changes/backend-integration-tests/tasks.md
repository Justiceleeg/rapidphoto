## 1. Testing Infrastructure Setup
- [ ] 1.1 Install testing dependencies
  - Install test framework (e.g., `vitest` or `node:test` with test runner)
  - Install HTTP client for making requests (e.g., `undici` or `node-fetch`)
  - Install test utilities for file handling
  - Verify installation
- [ ] 1.2 Create test server setup (`apps/api/tests/setup/test-server.ts`)
  - Function to start test server with actual Hono app
  - Configure test environment variables
  - Return server URL and cleanup function
  - Handle server lifecycle (start/stop)
- [ ] 1.3 Create test database setup (`apps/api/tests/setup/test-database.ts`)
  - Create test database connection with separate test database
  - Run migrations to setup schema
  - Provide cleanup/teardown utilities
  - Seed test data helpers (users, photos, jobs)
- [ ] 1.4 Create test R2 bucket utilities (`apps/api/tests/setup/test-r2.ts`)
  - Configure test R2 bucket (or use separate test bucket)
  - Utilities to upload test files to R2
  - Utilities to verify files exist in R2
  - Utilities to cleanup test files from R2
  - Handle presigned URL generation for testing
- [ ] 1.5 Create client simulation helpers (`apps/api/tests/setup/test-client.ts`)
  - Helper to make authenticated HTTP requests
  - Helper to simulate signup/signin and get session cookies
  - Helper to upload files to presigned URLs
  - Helper to make API requests with proper headers/cookies

## 2. Authentication Flow Integration Tests
- [ ] 2.1 Create auth flow test file (`apps/api/tests/integration/auth-flow.test.ts`)
- [ ] 2.2 Test user signup flow
  - Simulate client POST to `/api/auth/sign-up`
  - Verify user is created in database
  - Verify session is established
  - Verify cookies are returned
- [ ] 2.3 Test user signin flow
  - Simulate client POST to `/api/auth/sign-in`
  - Verify session is established
  - Verify cookies are returned
  - Verify invalid credentials return error
- [ ] 2.4 Test session management
  - Simulate client GET to `/api/me` with session cookies
  - Verify user data is returned
  - Verify session persists across requests
  - Test signout invalidates session
- [ ] 2.5 Test protected routes
  - Verify unauthenticated requests return 401
  - Verify authenticated requests succeed

## 3. End-to-End Upload Flow Integration Tests
- [ ] 3.1 Create upload flow test file (`apps/api/tests/integration/upload-flow.test.ts`)
- [ ] 3.2 Test complete single photo upload flow
  - Simulate client authentication (signup/signin)
  - Simulate client POST to `/api/upload/init` with photo metadata
  - Verify upload job and photo records are created in database
  - Verify presigned URL is returned
  - **Actually upload test file to R2 using presigned URL**
  - **Verify file exists in R2 bucket**
  - Simulate client POST to `/api/photos/:id/complete`
  - Verify photo status is updated to "completed" in database
  - Verify R2 URL is set correctly
  - Verify file is accessible in R2
- [ ] 3.3 Test complete batch upload flow (multiple photos)
  - Simulate client authentication
  - Simulate client POST to `/api/upload/init` with multiple photo metadata
  - Verify upload job and all photo records are created
  - Verify presigned URLs are returned for all photos
  - **Actually upload multiple test files to R2 using presigned URLs**
  - **Verify all files exist in R2 bucket**
  - Simulate client completion for each photo
  - Verify upload job progress updates correctly
  - Verify job status transitions: pending → in-progress → completed
  - Verify all files are accessible in R2
- [ ] 3.4 Test upload failure flow
  - Simulate client authentication
  - Simulate client POST to `/api/upload/init`
  - Simulate client POST to `/api/photos/:id/failed`
  - Verify photo status is updated to "failed" in database
  - Verify upload job progress tracks failed photos
  - Verify job status updates correctly when all photos fail
- [ ] 3.5 Test concurrent uploads
  - Simulate multiple concurrent upload requests
  - Verify all uploads are handled correctly
  - Verify database state is consistent
  - Verify all files are stored correctly in R2
- [ ] 3.6 Test upload validation
  - Verify invalid file count returns error
  - Verify invalid file size returns error
  - Verify unauthenticated requests return 401
  - Verify photo ownership validation works

## 4. SSE Progress Updates Integration Tests
- [ ] 4.1 Create SSE test file (`apps/api/tests/integration/sse-flow.test.ts`)
- [ ] 4.2 Test SSE connection
  - Simulate client GET to `/api/upload-progress/:jobId` with authentication
  - Verify SSE connection is established
  - Verify proper content-type headers are returned
  - Verify initial state is sent
- [ ] 4.3 Test SSE progress events during upload
  - Start SSE connection for upload job
  - Simulate photo completions
  - Verify progress events are received via SSE
  - Verify event data format is correct
  - Verify job status updates are reflected in events
- [ ] 4.4 Test SSE error handling
  - Verify invalid job ID returns error
  - Verify non-existent job returns error
  - Verify unauthorized access returns error
  - Verify connection closes when job completes

## 5. Test Scripts and Configuration
- [ ] 5.1 Add test scripts to package.json
  - `test` - Run all integration tests
  - `test:watch` - Run tests in watch mode
  - `test:integration` - Run only integration tests
  - Configure test environment variables
- [ ] 5.2 Create test environment configuration
  - Test database URL
  - Test R2 bucket configuration
  - Test server port configuration
  - Environment variable setup for tests

## 6. Test Execution and Verification
- [ ] 6.1 Run all integration tests
  - Execute `pnpm test`
  - Verify all tests pass
  - Verify test coverage includes full upload flow
- [ ] 6.2 Verify end-to-end flow
  - Confirm tests validate: client → API → database → R2 storage
  - Confirm tests actually upload files to R2
  - Confirm tests verify files are stored correctly
  - Confirm tests verify database state matches R2 state
- [ ] 6.3 Cleanup and documentation
  - Ensure test cleanup removes all test data
  - Document test setup requirements
  - Document how to run tests
  - Document test R2 bucket configuration
